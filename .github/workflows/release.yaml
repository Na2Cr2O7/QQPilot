name: release

on:
  workflow_dispatch:   # 手动触发

jobs:
  build:
    runs-on: windows-latest   # Windows eenner，自带 MSBuild、.NET SDK、7z 等工具
    steps:
      # 1. 拉取代码
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 设置 CMake（runner 已预装，但这里确保版本）
      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake
        with:
          cmake-version: '3.24'

      # 3. 设置 .NET SDK（runner 已预装，但这里确保版本）
      - name: Setup .NET
        uses: actions/setup-dotnet
        with:
          dotnet-version: '10.0.x'
          cache: true   # ✅ 启用缓存，加快后续运行

      # 4. 设置 MSBuild（Windows runner 已预装）
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2.0.0

      # 5. 缓存 CMake 构建目录
      - name: Cache CMake Build
        uses: actions/cache@v4
        with:
          path: |
            build_FocusQQWindow2
            build_ScaleToINI
            build_Vimage
            build_uploadFile
          key: ${{ runner.os }}-cmake-${{ hashFiles('VisionQQ_C/FocusQQWindow2/CMakeLists.txt', 'VisionQQ_C/ScaleToINI/CMakeLists.txt', 'VisionQQ_C/Vimage/CMakeLists.txt', 'VisionQQ_C/uploadFile/CMakeLists.txt') }}

      # 6. 缓存 NuGet 包（C# 项目依赖）
      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~\.nuget\packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.slnx', '**/*.sln', '**/*.csproj') }}

      # 7. 构建多个 C++ 项目
      - name: Build C++ FocusQQWindow2
        run: |
          cmake -S VisionQQ_C/FocusQQWindow2 -B build_FocusQQWindow2 -DCMAKE_BUILD_TYPE=Release
          cmake --build build_FocusQQWindow2 --config Release
          if not exist artifacts mkdir artifacts
          copy build_FocusQQWindow2\Release\*.dll artifacts\

      - name: Build C++ ScaleToINI
        run: |
          cmake -S VisionQQ_C/ScaleToINI -B build_ScaleToINI -DCMAKE_BUILD_TYPE=Release
          cmake --build build_ScaleToINI --config Release
          copy build_ScaleToINI\Release\*.exe artifacts\

      - name: Build C++ Vimage
        run: |
          cmake -S VisionQQ_C/Vimage -B build_Vimage -DCMAKE_BUILD_TYPE=Release
          cmake --build build_Vimage --config Release
          copy build_Vimage\Release\*.dll artifacts\

      - name: Build C++ uploadFile
        run: |
          cmake -S VisionQQ_C/uploadFile -B build_uploadFile -DCMAKE_BUILD_TYPE=Release
          cmake --build build_uploadFile --config Release
          copy build_uploadFile\Release\*.dll artifacts\

      # 8. 构建多个 .slnx 项目
      - name: Build C# Solution A
        run: |
          msbuild Opt\Opt.sln /p:Configuration=Release
          copy Opt\bin\Release\net9.0-windows7.0\*.dll artifacts\
          copy Opt\bin\Release\net9.0-windows7.0\*.exe artifacts\

      - name: Build C# Solution B
        run: |
          msbuild update\update.slnx /p:Configuration=Release
          copy update\bin\Release\net10.0-windows\*.dll artifacts\
          copy update\bin\Release\net10.0-windows\*.exe artifacts\

      # 9. 收集 Python 脚本和其他文件
      - name: Collect Scripts
        run: |
          copy *.py artifacts\
          copy *.cmd artifacts\
          copy *.bat artifacts\

      # 10. 打包成 7z
      - name: Package Artifacts
        run: |
          7z a artifacts.7z artifacts\*

      # 11. 上传构建产物
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: artifacts.7z
